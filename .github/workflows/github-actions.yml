name: Assignment 3 - Fast Build

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ§© Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: ğŸ§° Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu build-essential qemu-system-aarch64 cpio

      - name: ğŸ’¾ Restore Build Cache
        uses: actions/cache@v4
        with:
          path: |
            /tmp/aeld-cache
          key: aeld-cache-${{ runner.os }}-${{ hashFiles('finder-app/manual-linux.sh') }}
          restore-keys: |
            aeld-cache-${{ runner.os }}-

      - name: âš™ï¸ Run Manual Kernel + RootFS Build
        run: |
          cd finder-app
          chmod +x manual-linux.sh
          ./manual-linux.sh /tmp/aeld

      - name: ğŸ§ª Verify Output Files
        run: |
          ls -lh /tmp/aeld
          file /tmp/aeld/Image
          file /tmp/aeld/initramfs.cpio.gz

      - name: ğŸ’¾ Save Build Cache
        if: always()
        uses: actions/cache/save@v4
        with:
          path: /tmp/aeld-cache
          key: aeld-cache-${{ runner.os }}-${{ hashFiles('finder-app/manual-linux.sh') }}

      - name: âœ… Done
        run: echo "ğŸ‰ Fast cached build completed successfully!"

